name: Reusable GitOps Update Workflow
concurrency: ${{ inputs.concurrency-group }}

on:
  workflow_call:
    inputs:
      service:
        description: 'Service name (for logging purposes)'
        required: true
        type: string
      concurrency-group:
        description: 'Concurrency group to prevent parallel updates'
        required: false
        type: string
        default: gitops-update
      image-tag:
        description: 'Docker image tag to update (typically commit SHA)'
        required: true
        type: string
      helm-values-file:
        description: 'Path to Helm values file to update'
        required: false
        type: string
        default: helm/web-app/values-production.yaml
      argocd-app-file:
        description: 'Path to ArgoCD Application file to update (optional)'
        required: false
        type: string
        default: argocd/applications/web-app-production.yaml
      update-argocd:
        description: 'Whether to update ArgoCD Application manifest'
        required: false
        type: boolean
        default: true
      commit-message:
        description: 'Custom commit message (will append image tag)'
        required: false
        type: string
        default: 'chore: update image tag to'
      git-user-name:
        description: 'Git user name for commits'
        required: false
        type: string
        default: 'github-actions[bot]'
      git-user-email:
        description: 'Git user email for commits'
        required: false
        type: string
        default: 'github-actions[bot]@users.noreply.github.com'
      skip-ci-tag:
        description: 'Add [skip ci] to commit message'
        required: false
        type: boolean
        default: true
    secrets:
      GH_TOKEN:
        description: 'GitHub token with write permissions'
        required: false

    outputs:
      helm-updated:
        description: 'Whether Helm values were updated'
        value: ${{ jobs.update.outputs.helm-updated }}
      argocd-updated:
        description: 'Whether ArgoCD application was updated'
        value: ${{ jobs.update.outputs.argocd-updated }}
      commit-sha:
        description: 'SHA of the commit created (if any)'
        value: ${{ jobs.update.outputs.commit-sha }}

jobs:
  update:
    runs-on: ubuntu-latest
    outputs:
      helm-updated: ${{ steps.update-helm.outputs.updated }}
      argocd-updated: ${{ steps.update-argocd.outputs.updated }}
      commit-sha: ${{ steps.push-changes.outputs.commit-sha }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "${{ inputs.git-user-name }}"
          git config user.email "${{ inputs.git-user-email }}"

      - name: Update Helm values file
        id: update-helm
        run: |
          IMAGE_TAG="${{ inputs.image-tag }}"
          HELM_FILE="${{ inputs.helm-values-file }}"

          echo "================================================"
          echo "Updating Helm Values for ${{ inputs.service }}"
          echo "================================================"
          echo "File: $HELM_FILE"
          echo "Image Tag: $IMAGE_TAG"
          echo ""

          if [ ! -f "$HELM_FILE" ]; then
            echo "❌ Error: Helm values file not found: $HELM_FILE"
            exit 1
          fi

          # Backup original file
          cp "$HELM_FILE" "${HELM_FILE}.backup"

          # Update the image tag in values file
          # This handles both quoted and unquoted tag values
          sed -i.tmp "s|tag: [\"']\{0,1\}[^\"']*[\"']\{0,1\}|tag: \"${IMAGE_TAG}\"|g" "$HELM_FILE"
          rm -f "${HELM_FILE}.tmp"

          # Show the changes
          echo "=== Changes to Helm Values ==="
          if git diff --quiet "$HELM_FILE"; then
            echo "ℹ️  No changes detected (tag may already be set to $IMAGE_TAG)"
            echo "updated=false" >> $GITHUB_OUTPUT
          else
            git diff "$HELM_FILE"
            echo ""
            echo "✅ Helm values updated successfully"
            echo "updated=true" >> $GITHUB_OUTPUT
            git add "$HELM_FILE"
          fi

      - name: Update ArgoCD Application manifest
        id: update-argocd
        if: inputs.update-argocd == true
        run: |
          IMAGE_TAG="${{ inputs.image-tag }}"
          ARGOCD_FILE="${{ inputs.argocd-app-file }}"

          echo ""
          echo "================================================"
          echo "Updating ArgoCD Application for ${{ inputs.service }}"
          echo "================================================"
          echo "File: $ARGOCD_FILE"
          echo "Image Tag: $IMAGE_TAG"
          echo ""

          if [ ! -f "$ARGOCD_FILE" ]; then
            echo "ℹ️  ArgoCD application file not found: $ARGOCD_FILE"
            echo "Skipping ArgoCD update (this is normal if not using ArgoCD)"
            echo "updated=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Backup original file
          cp "$ARGOCD_FILE" "${ARGOCD_FILE}.backup"

          # Update image tag parameter in ArgoCD application
          # Look for the image.tag parameter and update its value
          sed -i.tmp "/name: image.tag/,/value:/ s|value: .*|value: \"${IMAGE_TAG}\"|" "$ARGOCD_FILE"
          rm -f "${ARGOCD_FILE}.tmp"

          # Show the changes
          echo "=== Changes to ArgoCD Application ==="
          if git diff --quiet "$ARGOCD_FILE"; then
            echo "ℹ️  No changes detected (tag may already be set to $IMAGE_TAG)"
            echo "updated=false" >> $GITHUB_OUTPUT
          else
            git diff "$ARGOCD_FILE"
            echo ""
            echo "✅ ArgoCD application updated successfully"
            echo "updated=true" >> $GITHUB_OUTPUT
            git add "$ARGOCD_FILE"
          fi

      - name: Commit and push changes
        id: push-changes
        run: |
          IMAGE_TAG="${{ inputs.image-tag }}"
          COMMIT_MSG="${{ inputs.commit-message }} ${IMAGE_TAG}"

          if [ "${{ inputs.skip-ci-tag }}" == "true" ]; then
            COMMIT_MSG="${COMMIT_MSG} [skip ci]"
          fi

          echo ""
          echo "================================================"
          echo "Committing Changes"
          echo "================================================"

          # Check if there are any staged changes
          if git diff --cached --quiet; then
            echo "ℹ️  No changes to commit"
            echo "commit-sha=" >> $GITHUB_OUTPUT
          else
            # Show what will be committed
            echo "Files to commit:"
            git diff --cached --name-only

            echo ""
            echo "Commit message: $COMMIT_MSG"

            # Commit the changes
            git commit -m "$COMMIT_MSG"

            # Get the commit SHA
            COMMIT_SHA=$(git rev-parse HEAD)
            echo "commit-sha=$COMMIT_SHA" >> $GITHUB_OUTPUT

            # Push to remote
            echo ""
            echo "Pushing changes to remote..."
            git push

            echo ""
            echo "✅ Changes committed and pushed successfully"
            echo "Commit SHA: $COMMIT_SHA"
          fi

      - name: Summary
        run: |
          echo "### GitOps Update Summary - ${{ inputs.service }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** \`${{ inputs.image-tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Updates Applied" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.update-helm.outputs.updated }}" == "true" ]; then
            echo "- ✅ Helm values updated: \`${{ inputs.helm-values-file }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ℹ️  Helm values unchanged: \`${{ inputs.helm-values-file }}\`" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ inputs.update-argocd }}" == "true" ]; then
            if [ "${{ steps.update-argocd.outputs.updated }}" == "true" ]; then
              echo "- ✅ ArgoCD application updated: \`${{ inputs.argocd-app-file }}\`" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ℹ️  ArgoCD application unchanged: \`${{ inputs.argocd-app-file }}\`" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- ⏭️  ArgoCD update skipped" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -n "${{ steps.push-changes.outputs.commit-sha }}" ]; then
            echo "**Commit SHA:** \`${{ steps.push-changes.outputs.commit-sha }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ Changes committed and pushed to repository" >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️  No changes were necessary - image tag already up to date" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs.update-argocd }}" == "true" ] && [ "${{ steps.update-argocd.outputs.updated }}" == "true" ]; then
            echo "- ArgoCD will automatically detect and sync the changes" >> $GITHUB_STEP_SUMMARY
            echo "- Monitor sync status: \`argocd app get ${{ inputs.service }}-production\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Deploy using Helm or your deployment tool of choice" >> $GITHUB_STEP_SUMMARY
            echo "- Or configure ArgoCD to watch this repository" >> $GITHUB_STEP_SUMMARY
          fi
